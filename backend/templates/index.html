<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>個人化新聞聚合器</title>
	<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0c10; --card: #121318; --text: #e5e7eb; --muted: #9aa0a6;
            --brand: #3b82f6; --brand-2: #22c55e; --border: #1f2937;
        }
		/* Light theme variables */
		[data-theme="light"] {
			--bg: #f6f7fb; --card: #ffffff; --text: #111827; --muted: #6b7280;
			--brand: #2563eb; --brand-2: #16a34a; --border: #e5e7eb;
		}
        * { box-sizing: border-box; }
		body { background: #faf5e9; color: var(--text); font-family: 'Patrick Hand', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; }
		body[data-theme="light"] { background: #fffaf0; }
        .container { max-width: 1200px; padding: 24px; margin: 0 auto; }
        header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
		h1 { font-size: 26px; margin: 0 12px 0 0; color: #0f172a; }
		input, button, select { padding: 10px 12px; font-size: 16px; border-radius: 14px; border: 2px dashed #2f3b4a; background: #ffffff; color: #0f172a; box-shadow: 3px 3px 0 #2f3b4a; }
		button { background: #fff7cc; color: #0f172a; cursor: pointer; transition: transform .05s ease-in-out, opacity .2s; border: 3px dashed #2f3b4a; box-shadow: 4px 4px 0 #2f3b4a; font-size: 20px; }
		button.secondary { background: #fff7cc; }
        button:hover { opacity: .92; }
        button:active { transform: translateY(1px); }
        /* layout */
        .layout { display: grid; grid-template-columns: 1fr; gap: 16px; }
        @media (min-width: 1000px) { .layout { grid-template-columns: 280px 1fr; } }
        .toolbar { background: rgba(255,255,255,0.92); border: 2px dashed #2f3b4a; border-radius: 18px; padding: 12px; display: flex; gap: 10px; flex-wrap: wrap; position: sticky; top: 12px; z-index: 20; box-shadow: 4px 4px 0 #2f3b4a; filter: url(#sketch-wobble); }
        [data-theme="light"] .toolbar { background: rgba(255,255,255,0.96); }
        .toolbar input[type="search"] { min-width: 240px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 18px; }
        .article { background: #ffffff; border: 2px dashed #2f3b4a; border-radius: 18px; padding: 16px; transition: box-shadow .2s, transform .1s; box-shadow: 4px 4px 0 #2f3b4a; filter: url(#sketch-wobble); }
        .article:hover { box-shadow: 6px 6px 0 #2f3b4a; transform: translateY(-1px) rotate(-0.3deg); }
        .article h3 { margin: 0 0 6px; font-size: 20px; color: #0f172a; }
        .article p { color: #0f172a; line-height: 1.6; }
        .meta { color: #334155; font-size: 13px; margin-top: 2px; display:flex; gap:6px; align-items:center; }
        .badge { border: 2px dashed #2f3b4a; background: #ffffff; padding: 2px 10px; border-radius: 999px; font-size: 12px; color: #0f172a; box-shadow: 2px 2px 0 #2f3b4a; filter: url(#sketch-wobble); }
        .actions { margin-top: 8px; display: flex; gap: 8px; }
        button.saved { background: var(--brand-2); color: #fff; }
        a { color: #0b57d0; text-decoration: none; }
        a:hover { text-decoration: underline; }
		/* Images from summaries: keep tidy */
		.article img { max-width: 100%; height: auto; max-height: 220px; object-fit: cover; border-radius: 12px; margin-top: 8px; display: block; }
        .meta img.logo { width: 16px; height: 16px; border-radius: 4px; display: inline-block; }

        /* skeleton */
        .skeleton { background: linear-gradient(90deg, rgba(0,0,0,.04) 25%, rgba(0,0,0,.06) 37%, rgba(0,0,0,.04) 63%); background-size: 400% 100%; animation: shimmer 1.2s ease-in-out infinite; border-radius: 18px; border: 2px dashed #2f3b4a; box-shadow: 3px 3px 0 #2f3b4a; }
        .skel-card { height: 160px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* chips */
		.chips { display:flex; flex-wrap: wrap; gap:10px; margin: 8px 0 12px; }
		.chip { padding:10px 14px; border:3px dashed #2f3b4a; background:#fff7cc; color:#0f172a; border-radius:999px; font-size:16px; cursor:pointer; box-shadow: 4px 4px 0 #2f3b4a; font-weight:700; }
		.chip.active { background: #fff7cc; color:#0b57d0; border-color: #0b57d0; }

        /* stats */
        .stats { display:grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap:12px; margin:12px 0; }
        .stat { background: #ffffff; border:2px dashed #2f3b4a; border-radius:16px; padding:12px; font-size:13px; box-shadow: 3px 3px 0 #2f3b4a; }
    </style>
<svg width="0" height="0" style="position:absolute">
  <filter id="sketch-wobble">
    <feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="1" seed="3" result="noise"/>
    <feDisplacementMap in="SourceGraphic" in2="noise" scale="1" xChannelSelector="R" yChannelSelector="G"/>
  </filter>
</svg>
</head>
<body>
<div class="container">
<header>
    <h1>個人化新聞</h1>
    <input id="email" placeholder="you@example.com"/>
    <button id="createUser">建立 / 使用</button>
    <span id="userInfo" class="badge"></span>
    <button id="refresh" class="secondary">刷新</button>
    <button id="themeToggle" class="secondary" title="切換明暗">主題</button>
    <button id="densityToggle" class="secondary" title="切換密度">密度</button>
    <button id="mySaves" class="secondary" title="查看收藏">我的收藏</button>
</header>

<!-- removed duplicate top toolbar -->
<div class="layout">
    <aside>
        <section class="toolbar">
            <label>分類
                <select id="category">
                    <option value="">全部</option>
                </select>
            </label>
            <label>來源
                <select id="source">
                    <option value="">全部</option>
                </select>
            </label>
            <label>國家
                <select id="country">
                    <option value="">全部</option>
                </select>
            </label>
            <label>語言
                <select id="lang">
                    <option value="">全部</option>
                </select>
            </label>
            <input id="search" type="search" placeholder="搜尋標題或摘要..." />
            <label>排序
                <select id="order">
                    <option value="newest" selected>最新</option>
                    <option value="oldest">最舊</option>
                    <option value="popular">熱門</option>
                </select>
            </label>
            <button id="applyFilters">套用</button>
        </section>
        <section class="stats" id="stats"></section>
    </aside>
    <main>
        <div id="chips" class="chips"></div>
        <div id="chipsSaved" class="chips"></div>
        <div id="articles" class="grid"></div>
        <div id="sentinel" style="height:1px"></div>
    </main>
</div>
</div>
<script>
var API_BASE = '';
var currentUserId = window.currentUserId || null;
var savedIds = window.savedIds || new Set();
	// Theme toggle with persistence
	(function(){
		const pref = localStorage.getItem('theme') || 'dark';
		if (pref === 'light') document.body.dataset.theme = 'light';
		document.getElementById('themeToggle').addEventListener('click', () => {
			const next = document.body.dataset.theme === 'light' ? 'dark' : 'light';
			document.body.dataset.theme = next === 'light' ? 'light' : '';
			localStorage.setItem('theme', next);
		});
	})();

	function logoForSource(src) {
		if (!src) return '';
		const map = {
			'BBC Technology': 'https://www.bbc.com/favicon.ico',
			'BBC World': 'https://www.bbc.com/favicon.ico',
			'NYTimes Technology': 'https://www.nytimes.com/favicon.ico',
			'NYTimes World': 'https://www.nytimes.com/favicon.ico',
			'The Guardian World': 'https://www.theguardian.com/favicon.ico',
			'The Guardian Technology': 'https://www.theguardian.com/favicon.ico',
			'Ars Technica': 'https://arstechnica.com/favicon.ico',
			'Al Jazeera': 'https://www.aljazeera.com/favicon.ico',
			'SCMP Hong Kong': 'https://www.scmp.com/favicon.ico',
			'Hong Kong Free Press': 'https://hongkongfp.com/favicon.ico',
			'明報 即時': 'https://news.mingpao.com/favicon.ico',
			'The Standard 即時': 'https://www.thestandard.com.hk/favicon.ico',
			'Now News 本地': 'https://news.now.com/favicon.ico',
			'RTHK 即時本地': 'https://rthk.hk/favicon.ico',
			'HK01': 'https://www.hk01.com/favicon.ico'
		};
		return map[src] || '';
	}

async function createOrUseUser() {
	const email = document.getElementById('email').value.trim();
	if (!email) return;
	const res = await fetch(`${API_BASE}/users`, {
		method: 'POST', headers: { 'Content-Type': 'application/json' },
		body: JSON.stringify({ email })
	});
	const data = await res.json();
	currentUserId = data.id;
	document.getElementById('userInfo').textContent = `User ID: ${currentUserId}`;
	await loadSavedIds();
	await refreshArticles();
}

var META = { categories: [], sources: [], countries: [], languages: [] };
async function loadMeta() {
    const res = await fetch(`${API_BASE}/meta`);
    const meta = await res.json();
    META = meta;
    const cat = document.getElementById('category');
    const src = document.getElementById('source');
    const cty = document.getElementById('country');
    const lng = document.getElementById('lang');
    const catDisp = meta.category_display || {};
    for (const c of meta.categories) {
        const o = document.createElement('option'); o.value = c; o.textContent = catDisp[c] || c; cat.appendChild(o);
    }
    for (const s of meta.sources) {
        const o = document.createElement('option'); o.value = s; o.textContent = s || '（未標示來源）'; src.appendChild(o);
    }
    const zhCountry = { hk:'香港', gb:'英國', us:'美國', cn:'中國', jp:'日本', kr:'南韓', sg:'新加坡', tw:'台灣', my:'馬來西亞', th:'泰國', vn:'越南', ph:'菲律賓', id:'印尼', au:'澳洲', ca:'加拿大', de:'德國', fr:'法國', es:'西班牙', it:'意大利', nz:'紐西蘭' };
    for (const c of meta.countries) {
        const o = document.createElement('option'); o.value = c; o.textContent = zhCountry[c] || c || '（未標示）'; cty.appendChild(o);
    }
    const zhLang = { en:'英文', zh:'中文', ja:'日文', ko:'韓文', fr:'法文', de:'德文', es:'西文', it:'意大利文' };
    for (const l of (meta.languages || [])) {
        const o = document.createElement('option'); o.value = l; o.textContent = zhLang[l] || l || '（未標示）'; lng.appendChild(o);
    }
}

var currentPage = window.currentPage || 1;
var isLoading = false;
var reachedEnd = false;
var viewingTrending = window.viewingTrending || false;
var viewingSaves = window.viewingSaves || false;

function renderSkeleton(count=9) {
    const container = document.getElementById('articles');
    container.innerHTML = '';
    for (let i=0;i<count;i++) {
        const s = document.createElement('div');
        s.className = 'skeleton skel-card';
        container.appendChild(s);
    }
}

async function refreshArticles() {
    if (isLoading) return; isLoading = true; reachedEnd = false; currentPage = 1; renderSkeleton();
    const qs = new URLSearchParams();
    if (currentUserId) qs.set('user_id', String(currentUserId));
    const category = document.getElementById('category').value;
    const source = document.getElementById('source').value;
    const order = document.getElementById('order').value;
    const country = document.getElementById('country').value;
    const q = document.getElementById('search').value.trim();
    const lang = document.getElementById('lang').value;
    if (category) qs.set('category', category);
    if (source) qs.set('source', source);
    if (country) qs.set('country', country);
    if (order) qs.set('order', order);
    if (lang) qs.set('lang', lang);
    if (q) qs.set('q', q);
    qs.set('page', String(currentPage));
    qs.set('page_size', '30');
    const res = await fetch(`${API_BASE}/articles?${qs.toString()}`);
	const articles = await res.json();
	const container = document.getElementById('articles');
	container.innerHTML = '';
	for (const a of articles) {
        const div = document.createElement('div');
        div.className = 'article';
		const safeSummary = (a.summary || '').replace(/<img[^>]*>/gi, '');
		div.innerHTML = `
            <a href="${a.url}" target="_blank"><h3>${a.title}</h3></a>
            <div class="meta">
				${logoForSource(a.source) ? `<img class="logo" src="${logoForSource(a.source)}" alt=""/>` : ''}
                <span class="badge">${a.source || ''}</span>
                <span class="badge">${a.category || 'general'}</span>
                <span>${a.published_at ? new Date(a.published_at).toLocaleString() : ''}</span>
            </div>
			<p>${safeSummary}</p>
            <div class="actions">
                <button data-like="1" data-id="${a.id}">喜歡</button>
                <button data-like="0" data-id="${a.id}" class="secondary">不喜歡</button>
                <button data-save="1" data-id="${a.id}" class="${(savedIds||new Set()).has(a.id) ? 'saved' : ''}">${(savedIds||new Set()).has(a.id) ? '已收藏' : '收藏'}</button>
            </div>
        `;
		container.appendChild(div);
	}
    for (const btn of document.querySelectorAll('.actions button')) {
        btn.addEventListener('click', async (e) => {
            if (!currentUserId) return;
            const articleId = parseInt(e.target.getAttribute('data-id'));
            if (e.target.hasAttribute('data-like')) {
                const liked = e.target.getAttribute('data-like') === '1';
                await fetch(`${API_BASE}/feedback`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUserId, article_id: articleId, liked })
                });
                await refreshArticles();
            }
            if (e.target.hasAttribute('data-save')) {
                const r = await fetch(`${API_BASE}/saves`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUserId, article_id: articleId, action: 'toggle' })
                });
                const j = await r.json();
                if (j.saved) { e.target.classList.add('saved'); e.target.textContent = 'Saved'; }
                else { e.target.classList.remove('saved'); e.target.textContent = 'Save'; }
            }
        });
    }

    // Infinite scroll sentinel
    const sentinel = document.getElementById('sentinel');
    if ('IntersectionObserver' in window) {
        const io = new IntersectionObserver(async (entries) => {
            for (const e of entries) {
                if ((viewingSaves || viewingTrending)) return;
                if (e.isIntersecting && !reachedEnd) {
                    currentPage += 1;
                    const qs2 = new URLSearchParams(qs.toString());
                    qs2.set('page', String(currentPage));
                    const res2 = await fetch(`${API_BASE}/articles?${qs2.toString()}`);
                    const moreArticles = await res2.json();
                    if (!Array.isArray(moreArticles) || moreArticles.length === 0) { reachedEnd = true; return; }
                    for (const a of moreArticles) {
                        const div2 = document.createElement('div');
                        div2.className = 'article';
                        div2.innerHTML = `
                            <a href="${a.url}" target="_blank"><h3>${a.title}</h3></a>
                            <div class="meta">
                                <span class="badge">${a.source || ''}</span>
                                <span class="badge">${a.category || 'general'}</span>
                                <span>${a.published_at ? new Date(a.published_at).toLocaleString() : ''}</span>
                            </div>
                            <p>${(a.summary || '').replace(/<img[^>]*>/gi, '')}</p>
                        `;
                        container.appendChild(div2);
                    }
                }
            }
        }, { rootMargin: '600px 0px' });
        io.observe(sentinel);
    }
    isLoading = false;
}

document.getElementById('createUser').addEventListener('click', createOrUseUser);

document.getElementById('refresh').addEventListener('click', refreshArticles);
document.getElementById('applyFilters').addEventListener('click', () => { currentPage = 1; refreshArticles(); });

document.getElementById('densityToggle').addEventListener('click', () => {
    const d = document.body.dataset.density === 'compact' ? '' : 'compact';
    document.body.dataset.density = d;
    localStorage.setItem('density', d || 'comfortable');
});
(function(){ const d = localStorage.getItem('density'); if (d === 'compact') document.body.dataset.density = 'compact'; })();

// status and chips
async function loadStatusAndChips() {
    try {
        const [stRes, statRes] = await Promise.all([
            fetch(`${API_BASE}/status`),
            fetch(`${API_BASE}/stats`),
        ]);
        const st = await stRes.json();
        const stats = await statRes.json();
        const statsBox = document.getElementById('stats');
        statsBox.innerHTML = '';
        const s1 = document.createElement('div'); s1.className='stat'; s1.innerHTML = `<div>Total Articles</div><div style="font-size:20px;font-weight:600;">${(st.total_articles||0).toLocaleString()}</div>`; statsBox.appendChild(s1);
        const s2 = document.createElement('div'); s2.className='stat'; s2.innerHTML = `<div>Last Published</div><div>${st.last_published_at ? new Date(st.last_published_at).toLocaleString() : '-'}</div>`; statsBox.appendChild(s2);
        const s3 = document.createElement('div'); s3.className='stat'; s3.innerHTML = `<div>Top Sources</div><div>${(stats.top_sources||[]).slice(0,5).map(x=>x.source).join(', ')}</div>`; statsBox.appendChild(s3);
        const s4 = document.createElement('div'); s4.className='stat'; s4.innerHTML = `<div>Top Categories</div><div>${(stats.top_categories||[]).slice(0,5).map(x=>x.category).join(', ')}</div>`; statsBox.appendChild(s4);
        const chipsEl = document.getElementById('chips');
        chipsEl.innerHTML = '';
        const zhCountry = { hk:'香港', gb:'英國', us:'美國', cn:'中國', jp:'日本', kr:'南韓', sg:'新加坡', tw:'台灣', my:'馬來西亞', th:'泰國', vn:'越南', ph:'菲律賓', id:'印尼', au:'澳洲', ca:'加拿大', de:'德國', fr:'法國', es:'西班牙', it:'意大利' };
        const zhLang = { en:'英文', zh:'中文', ja:'日文', ko:'韓文', fr:'法文', de:'德文', es:'西文' };
        (META.categories||[]).slice(0,8).forEach(c => { const d=document.createElement('div'); d.className='chip'; d.textContent=c; d.addEventListener('click',()=>{ viewingSaves=false; viewingTrending=false; document.getElementById('category').value=c; refreshArticles(); }); chipsEl.appendChild(d); });
        (META.countries||[]).slice(0,8).forEach(c => { const d=document.createElement('div'); d.className='chip'; d.textContent=zhCountry[c]||c; d.title=c; d.addEventListener('click',()=>{ viewingSaves=false; viewingTrending=false; document.getElementById('country').value=c; refreshArticles(); }); chipsEl.appendChild(d); });

        const chipsSaved = document.getElementById('chipsSaved');
        chipsSaved.innerHTML = '';
        const chipSaved = document.createElement('div'); chipSaved.className='chip'; chipSaved.textContent='Only Saved';
        chipSaved.addEventListener('click', async ()=>{ if (!currentUserId) return alert('Please Create/Use a user first'); viewingSaves=true; viewingTrending=false; await showMySaves(); });
        const chipTrending = document.createElement('div'); chipTrending.className='chip'; chipTrending.textContent='Trending';
        chipTrending.addEventListener('click', async ()=>{ viewingTrending=true; viewingSaves=false; await showTrending(); });
        const chipAll = document.createElement('div'); chipAll.className='chip'; chipAll.textContent='All Articles';
        chipAll.addEventListener('click', ()=>{ viewingSaves=false; viewingTrending=false; refreshArticles(); });
        chipsSaved.appendChild(chipSaved); chipsSaved.appendChild(chipTrending); chipsSaved.appendChild(chipAll);

        // country/lang stats
        try {
            const res = await fetch(`${API_BASE}/stats_country_lang`);
            const sdata = await res.json();
            const statsBox = document.getElementById('stats');
            const wrap = document.createElement('div'); wrap.className='stat';
            const lines = [];
            (sdata.countries||[]).slice(0,8).forEach(x=>{ lines.push(`${zhCountry[x.code]||x.code}: ${x.count}`); });
            lines.push('——');
            (sdata.languages||[]).slice(0,6).forEach(x=>{ lines.push(`${zhLang[x.code]||x.code}: ${x.count}`); });
            wrap.innerHTML = `<div>各國家/語言</div><div style="white-space:pre-line">${lines.join('\n')}</div>`;
            statsBox.appendChild(wrap);
        } catch(e) {}
    } catch(e) { }
}

loadMeta().then(()=>{ loadStatusAndChips(); refreshArticles(); });

async function loadSavedIds() {
    if (!currentUserId) return;
    try {
        const res = await fetch(`${API_BASE}/saves?user_id=${currentUserId}`);
        const arr = await res.json();
        savedIds = new Set((arr||[]).map(a => a.id));
    } catch (e) { savedIds = new Set(); }
}

async function showMySaves() {
    if (!currentUserId) return alert('Please Create/Use a user first');
    const container = document.getElementById('articles');
    container.innerHTML = '';
    renderSkeleton(6);
    const res = await fetch(`${API_BASE}/saves?user_id=${currentUserId}`);
    const articles = await res.json();
    container.innerHTML = '';
    for (const a of articles) {
        const div = document.createElement('div');
        div.className = 'article';
        const safeSummary = (a.summary || '').replace(/<img[^>]*>/gi, '');
        div.innerHTML = `
            <a href="${a.url}" target="_blank"><h3>${a.title}</h3></a>
            <div class="meta">
                <span class="badge">${a.source || ''}</span>
                <span class="badge">${a.category || 'general'}</span>
                <span>${a.published_at ? new Date(a.published_at).toLocaleString() : ''}</span>
            </div>
            <p>${safeSummary}</p>
            <div class="actions">
                <button data-save="1" data-id="${a.id}" class="saved">Saved</button>
            </div>
        `;
        container.appendChild(div);
    }
}

document.getElementById('mySaves').addEventListener('click', showMySaves);

async function showTrending() {
    const container = document.getElementById('articles');
    container.innerHTML = '';
    renderSkeleton(9);
    const res = await fetch(`${API_BASE}/trending`);
    const articles = await res.json();
    container.innerHTML = '';
    for (const a of articles) {
        const div = document.createElement('div');
        div.className = 'article';
        const safeSummary = (a.summary || '').replace(/<img[^>]*>/gi, '');
        div.innerHTML = `
            <a href="${a.url}" target="_blank"><h3>${a.title}</h3></a>
            <div class="meta">
                <span class="badge">${a.source || ''}</span>
                <span class="badge">${a.category || 'general'}</span>
                <span>${a.published_at ? new Date(a.published_at).toLocaleString() : ''}</span>
            </div>
            <p>${safeSummary}</p>
        `;
        container.appendChild(div);
    }
}
</script>
</body>
</html>
